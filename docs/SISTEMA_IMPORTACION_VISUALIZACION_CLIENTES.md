# Sistema de Importaci√≥n y Visualizaci√≥n de Clientes

## üìã Descripci√≥n General

Sistema flexible de importaci√≥n y visualizaci√≥n de datos de clientes que permite a cada tenant (financiera) definir:
- **Mapeo personalizado** de columnas desde sus archivos Excel/CSV
- **Configuraci√≥n de visualizaci√≥n** espec√≠fica para cada tenant
- **Importaci√≥n automatizada** con validaci√≥n y manejo de errores
- **Visualizaci√≥n din√°mica** de datos del cliente durante la gesti√≥n

## üèóÔ∏è Arquitectura

### Backend

#### 1. **Entidades Actualizadas**

##### Customer.java
```java
@Entity
@Table(name = "clientes")
public class Customer extends AggregateRoot {
    @Column(name = "id_inquilino", nullable = false)
    private Long tenantId;  // NUEVO: Identifica a qu√© financiera pertenece

    @Column(name = "codigo_documento", length = 50)
    private String documentCode;  // NUEVO: C√≥digo de documento del cliente

    @Column(name = "estado", length = 20)
    private String status;  // NUEVO: Estado del cliente (ACTIVO, INACTIVO)

    @Column(name = "fecha_importacion")
    private LocalDate importDate;  // NUEVO: Fecha de importaci√≥n

    // Relaciones existentes
    @OneToOne private ContactInfo contactInfo;
    @OneToOne private AccountInfo accountInfo;
    @OneToOne private DebtInfo debtInfo;
}
```

##### ContactInfo.java
```java
@Column(name = "telefono_celular", length = 20)
private String mobilePhone;  // NUEVO: Tel√©fono celular principal
```

##### DebtInfo.java
```java
@Column(name = "deuda_actual", precision = 15, scale = 2)
private BigDecimal currentDebt;  // NUEVO: Deuda actual total
```

#### 2. **Servicios Nuevos**

##### CustomerImportService.java
- **Importa clientes** desde Excel (.xlsx, .xls) o CSV
- **Lee configuraci√≥n del tenant** desde JSON
- **Mapea columnas** autom√°ticamente seg√∫n configuraci√≥n
- **Valida datos** y maneja errores
- **Actualiza o crea** clientes seg√∫n si existen

**M√©todos principales:**
```java
public ImportResult importCustomers(Long tenantId, MultipartFile file, String tenantCode)
private List<Customer> importFromExcel(...)
private List<Customer> importFromCSV(...)
private Customer mapToCustomer(Long tenantId, Map<String, String> rowData, CustomerDataMapping mapping)
```

#### 3. **Controladores REST**

##### CustomerImportController.java
```
POST /api/v1/customers/import
Parameters:
  - file: MultipartFile (Excel o CSV)
  - tenantId: Long
  - tenantCode: String

Response:
{
  "success": true,
  "importedCount": 150,
  "hasErrors": false,
  "errors": [],
  "message": "150 clientes importados exitosamente"
}
```

##### CustomerController.java (Endpoints agregados)
```
GET /api/v1/customers/by-document?tenantId={id}&documentCode={code}
- Busca un cliente por c√≥digo de documento dentro de un tenant

GET /api/v1/customers/display-config/{tenantCode}
- Retorna la configuraci√≥n de visualizaci√≥n del tenant
```

### Frontend

#### 1. **Servicios**

##### CustomerDisplayService.ts
- `getCustomerById(customerId)` - Obtiene cliente por ID
- `getCustomerByDocumentCode(tenantId, documentCode)` - Busca por documento
- `getDisplayConfig(tenantCode)` - Obtiene configuraci√≥n de visualizaci√≥n
- `importCustomers(file, tenantId, tenantCode)` - Importa archivo
- `formatValue(value, format)` - Formatea valores (currency, number, date)
- `getNestedValue(obj, path)` - Accede a propiedades anidadas

#### 2. **Componentes**

##### CustomerInfoDisplayComponent
Componente reutilizable que:
- Carga datos del cliente autom√°ticamente
- Obtiene configuraci√≥n de visualizaci√≥n del tenant
- Renderiza secciones din√°micamente seg√∫n JSON
- Aplica formatos y estilos configurables
- Muestra destacados (highlight) en campos importantes

**Uso:**
```html
<app-customer-info-display
  [documentCode]="'D000041692138'"
  [tenantId]="2"
  [tenantCode]="'FIN-OH'">
</app-customer-info-display>
```

## üìù Configuraci√≥n JSON por Tenant

### Estructura del JSON

Cada tenant tiene un archivo JSON en `src/main/resources/tenant-configurations/{tenant-code}.json`:

```json
{
  "tenantCode": "FIN-OH",
  "tenantName": "Financiera Oh",

  "customerDataMapping": {
    "importSourceType": "EXCEL",
    "sourceTableName": "ASIG_TEMP",

    "columnMapping": {
      "CODIGO_DOCUMENTO": "documentCode",
      "NOMBRE": "fullName",
      "NRO_CUENTA": "accountNumber",
      "CELULAR": "mobilePhone",
      "DEUDA_ACTUAL": "currentDebt",
      "DIAS_MORA": "daysOverdue"
    },

    "customerDisplayConfig": {
      "title": "Informaci√≥n del Cliente",
      "sections": [
        {
          "sectionTitle": "Datos Personales",
          "fields": [
            {
              "field": "documentCode",
              "label": "DNI/Documento",
              "displayOrder": 1
            },
            {
              "field": "fullName",
              "label": "Nombre Completo",
              "displayOrder": 2
            }
          ]
        },
        {
          "sectionTitle": "Informaci√≥n de Deuda",
          "colorClass": "danger",
          "fields": [
            {
              "field": "currentDebt",
              "label": "Deuda Actual",
              "displayOrder": 1,
              "format": "currency",
              "highlight": true
            },
            {
              "field": "daysOverdue",
              "label": "D√≠as de Mora",
              "displayOrder": 2,
              "format": "number",
              "highlight": true
            }
          ]
        }
      ]
    }
  }
}
```

### Campos de Visualizaci√≥n Soportados

#### Campos de Customer
- `documentCode` - C√≥digo de documento
- `fullName` - Nombre completo
- `status` - Estado del cliente

#### Campos de ContactInfo
- `contactInfo.mobilePhone` - Tel√©fono celular
- `contactInfo.primaryPhone` - Tel√©fono principal
- `contactInfo.alternativePhone` - Tel√©fono alternativo
- `contactInfo.workPhone` - Tel√©fono trabajo
- `contactInfo.email` - Correo electr√≥nico
- `contactInfo.address` - Direcci√≥n

#### Campos de AccountInfo
- `accountInfo.accountNumber` - N√∫mero de cuenta
- `accountInfo.productType` - Tipo de producto
- `accountInfo.disbursementDate` - Fecha de desembolso
- `accountInfo.originalAmount` - Monto original
- `accountInfo.termMonths` - Plazo en meses
- `accountInfo.interestRate` - Tasa de inter√©s

#### Campos de DebtInfo
- `debtInfo.currentDebt` - Deuda actual
- `debtInfo.capitalBalance` - Saldo capital
- `debtInfo.overdueInterest` - Inter√©s vencido
- `debtInfo.accumulatedLateFees` - Moras acumuladas
- `debtInfo.collectionFees` - Gastos de cobranza
- `debtInfo.totalBalance` - Saldo total
- `debtInfo.daysOverdue` - D√≠as de mora
- `debtInfo.lastPaymentDate` - Fecha √∫ltimo pago
- `debtInfo.lastPaymentAmount` - Monto √∫ltimo pago

### Formatos Soportados

- `currency` - Formato moneda (S/ 23,653.54)
- `number` - Formato n√∫mero (87)
- `date` - Formato fecha (DD/MM/YYYY)
- `text` - Texto sin formato

### Clases de Color para Secciones

- `danger` - Rojo (para deudas, alertas)
- `warning` - Naranja (para advertencias)
- `success` - Verde (para informaci√≥n positiva)
- Sin colorClass - Azul por defecto

## üöÄ Flujo de Uso

### 1. Importaci√≥n de Clientes

```bash
POST /api/v1/customers/import
Content-Type: multipart/form-data

file: clientes_financiera_oh.xlsx
tenantId: 2
tenantCode: FIN-OH
```

**Proceso:**
1. Backend recibe archivo
2. Lee configuraci√≥n de `tenant-configurations/fin-oh.json`
3. Obtiene mapeo de columnas del `columnMapping`
4. Lee cada fila del Excel/CSV
5. Mapea columnas origen ‚Üí campos destino
6. Valida datos requeridos
7. Verifica si cliente existe (por tenantId + documentCode)
8. Actualiza o crea cliente
9. Guarda en base de datos
10. Retorna resultado con errores si los hay

### 2. Visualizaci√≥n durante Gesti√≥n

```typescript
// En collection-management.page.ts
<app-customer-info-display
  [documentCode]="customerData().numero_documento"
  [tenantId]="selectedTenantId"
  [tenantCode]="'FIN-OH'">
</app-customer-info-display>
```

**Proceso:**
1. Componente recibe documentCode y tenantId
2. Llama a `GET /api/v1/customers/by-document?tenantId=2&documentCode=D000041692138`
3. Llama a `GET /api/v1/customers/display-config/FIN-OH`
4. Renderiza secciones seg√∫n configuraci√≥n JSON
5. Formatea valores seg√∫n `format` especificado
6. Aplica estilos seg√∫n `colorClass` y `highlight`

## üì¶ Dependencias Agregadas

```xml
<!-- Apache POI para Excel -->
<dependency>
    <groupId>org.apache.poi</groupId>
    <artifactId>poi-ooxml</artifactId>
    <version>5.2.5</version>
</dependency>

<!-- Apache Commons CSV -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-csv</artifactId>
    <version>1.10.0</version>
</dependency>
```

## ‚úÖ Ventajas del Sistema

### 1. **Flexibilidad Total por Tenant**
Cada financiera puede tener:
- Nombres de columnas diferentes en sus archivos
- Campos adicionales espec√≠ficos
- Visualizaci√≥n personalizada
- √ânfasis en campos importantes para su negocio

### 2. **F√°cil Mantenimiento**
- Solo editar JSON, no c√≥digo
- Copiar y modificar para nuevos tenants
- Sin recompilaci√≥n ni despliegue

### 3. **Validaci√≥n Autom√°tica**
- Campos requeridos
- Detecci√≥n de duplicados
- Actualizaci√≥n de clientes existentes
- Reporte detallado de errores

### 4. **Reutilizable**
- Componente de visualizaci√≥n independiente
- Servicio de importaci√≥n gen√©rico
- Configuraci√≥n declarativa

### 5. **Escalable**
- Maneja miles de registros
- Importaci√≥n por lotes
- Cach√© de configuraci√≥n

## üìã Ejemplo Completo

### Archivo Excel de Financiera Oh
```
CODIGO_DOCUMENTO | NOMBRE                         | NRO_CUENTA       | CELULAR   | DEUDA_ACTUAL | DIAS_MORA
D000041692138    | RAUL ERNESTO ARRIOLA SEVILLANO | 4040710025347160 | 949356887 | 23653.54     | 87
```

### Configuraci√≥n JSON (columnMapping)
```json
{
  "CODIGO_DOCUMENTO": "documentCode",
  "NOMBRE": "fullName",
  "NRO_CUENTA": "accountNumber",
  "CELULAR": "mobilePhone",
  "DEUDA_ACTUAL": "currentDebt",
  "DIAS_MORA": "daysOverdue"
}
```

### Resultado en Base de Datos
```sql
-- Tabla: clientes
id_inquilino: 2
codigo_documento: 'D000041692138'
nombre_completo: 'RAUL ERNESTO ARRIOLA SEVILLANO'
estado: 'ACTIVO'

-- Tabla: informacion_contacto
telefono_celular: '949356887'

-- Tabla: informacion_cuenta
numero_cuenta: '4040710025347160'

-- Tabla: informacion_deuda
deuda_actual: 23653.54
dias_mora: 87
```

### Visualizaci√≥n en Frontend
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üë§ Informaci√≥n del Cliente      [ACTIVO]‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Datos Personales                        ‚îÇ
‚îÇ DNI/Documento: D000041692138            ‚îÇ
‚îÇ Nombre: RAUL ERNESTO ARRIOLA SEVILLANO  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Informaci√≥n de Contacto                 ‚îÇ
‚îÇ ‚ö° Celular: 949356887                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚ö†Ô∏è Informaci√≥n de Deuda                 ‚îÇ
‚îÇ ‚ö° Deuda Actual: S/ 23,653.54           ‚îÇ
‚îÇ ‚ö° D√≠as de Mora: 87                     ‚îÇ
‚îÇ Nro. Cuenta: 4040710025347160           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîÑ Pr√≥ximos Pasos

1. ‚úÖ Sistema de importaci√≥n implementado
2. ‚úÖ Visualizaci√≥n din√°mica implementada
3. ‚úÖ Configuraci√≥n JSON por tenant
4. ‚è≥ Probar importaci√≥n con datos reales
5. ‚è≥ Agregar m√°s tenants de ejemplo
6. ‚è≥ Implementar importaci√≥n desde base de datos (ASIG_TEMP)
7. ‚è≥ Agregar validaciones de negocio adicionales
8. ‚è≥ Implementar sincronizaci√≥n autom√°tica mensual

## üìù Notas Importantes

- **Todos los nombres de columnas en BD est√°n en espa√±ol**
- **El sistema es multi-tenant**: Cada cliente pertenece a un tenant espec√≠fico
- **Actualizaci√≥n autom√°tica**: Si el cliente ya existe, se actualiza su informaci√≥n
- **Manejo de errores**: Los errores no detienen la importaci√≥n, se reportan al final
- **Configuraci√≥n centralizada**: Todo est√° en JSON, nada hardcodeado
